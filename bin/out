#!/usr/bin/ruby
require 'json'
require 'net/http'
require 'uri'
require 'pp'

input = JSON.parse(STDIN.read)

if ! input.has_key? "source"
  puts "Concourse input valiation failed, missing source"
  exit 132
end
source = input['source']

if ! input.has_key? "params"
  puts "Concourse input validation failed, missing params"
  exit 132
end
params = input['params']

if ! source.has_key? "uri"
  puts "No uri provided in resource source!"
  exit 132
end
if ! params.has_key? "message"
  puts "No message provided in resource source!"
  exit 132
end

uri = URI.parse(source["uri"])
request = Net::HTTP::Post.new(uri)
request.body = params["message"]
req_options = {
  use_ssl: uri.scheme == "https",
}

if source.has_key? "secret"
  request.add_field 'Authorization', "Bearer #{source["secret"]}"
end

response = Net::HTTP.start(uri.hostname, uri.port, req_options) do |http|
  http.request(request)
end
pp response.body
